from web3 import Web3
from time import time

web3 = Web3(Web3.HTTPProvider("http://127.0.0.1:8545")) 

if not web3.is_connected():
    print("Web3 connection failed!")
else:
    print("Connected to Web3 successfully!")

contract_address = "0xDc64a140Aa3E981100a9becA4E685f962f0cF6C9" # vuln contract address

import json
contract_abi = json.loads(open("./artifacts/contracts/vuln.sol/Vuln.json", "r").read())["abi"] # vuln contract abi

contract = web3.eth.contract(address=contract_address, abi=contract_abi)
private_key = "0x5de4111afa1a4b94908f83103eb1f1706367c2e68ca870fc3fb9a804cdab365a" ## my private key

account = web3.eth.account.from_key(private_key)
sender_address = account.address

def transfer_money():
    tx = contract.functions.transfer_money().build_transaction({
        "from": sender_address,
        "gas": 200000,
        "gasPrice": web3.eth.gas_price,
        "nonce": web3.eth.get_transaction_count(sender_address),
    })

    signed_tx = web3.eth.account.sign_transaction(tx, private_key)

    tx_hash = web3.eth.send_raw_transaction(signed_tx.raw_transaction)

    receipt = web3.eth.wait_for_transaction_receipt(tx_hash)
    
    return receipt

def fail():
    tx = contract.functions.fail().build_transaction({
        "from": sender_address,
        "gas": 200000,
        "gasPrice": web3.eth.gas_price,
        "nonce": web3.eth.get_transaction_count(sender_address),
    })

    signed_tx = web3.eth.account.sign_transaction(tx, private_key)

    tx_hash = web3.eth.send_raw_transaction(signed_tx.raw_transaction)

    receipt = web3.eth.wait_for_transaction_receipt(tx_hash)
    
    return receipt

## simulating normal interaction
print("=== Starting the Exploit ===")
for i in range(10):
    if i % 2 == 0:
        transfer_money()
    else:
        fail()

## simulating burst of failure events
for i in range(100):
    fail()

